#######################################################################################################################
# Upsun demo project configuration
#######################################################################################################################
# Application configuration.
applications:    
    # App 1: Frontend (JS)
    drupal:

        source:
            root: "drupal"

        type: "php:8.1"

        dependencies:
            php:
               composer/composer: '^2'

        build:
            flavor: composer

        mounts:
            # The default Drupal files directory.
            '/web/sites/default/files':
                source: local
                source_path: 'files'
            # Drupal gets its own dedicated tmp directory. The settings.platformsh.php
            # file will automatically configure Drupal to use this directory.
            '/tmp':
                source: local
                source_path: 'tmp'
            # Private file uploads are stored outside the web root. The settings.platformsh.php
            # file will automatically configure Drupal to use this directory.
            '/private':
                source: local
                source_path: 'private'
            # Drush needs a scratch space for its own caches.
            '/.drush':
                source: local
                source_path: 'drush'
            # Drush will try to save backups to this directory, so it must be
            # writeable even though you will almost never need to use it.
            '/drush-backups':
                source: local
                source_path: 'drush-backups'
            # Drupal Console will try to save backups to this directory, so it must be
            # writeable even though you will almost never need to use it.
            '/.console':
                source: local
                source_path: 'console'

        hooks:
            build: |
                set -e
            # deploy: | 
            #     set -e
            #     php ./drush/platformsh_generate_drush_yml.php
            #     # if drupal is installed, will call the following drush commands:
            #     #   - `cache-rebuild`
            #     #   - `updatedb`
            #     #   - and if config files are present, `config-import`
            #     cd web
            #     bash $PLATFORM_APP_DIR/drush/platformsh_deploy_drupal.sh

        relationships:
            database: 'db:mysql'
            redis: 'cache:redis'

        web:
            locations:
                /:
                    root: 'web'
                    expires: 5m
                    passthru: '/index.php'
                    allow: false
                    rules:
                        # Allow access to common static files.
                        '\.(jpe?g|png|gif|svgz?|css|js|map|ico|bmp|eot|woff2?|otf|ttf)$':
                            allow: true
                        '^/robots\.txt$':
                            allow: true
                        '^/sitemap\.xml$':
                            allow: true

                        # Deny direct access to configuration files.
                        '^/sites/sites\.php$':
                            scripts: false
                        '^/sites/[^/]+/settings.*?\.php$':
                            scripts: false
                        # The files directory has its own special configuration rules.
                '/sites/default/files':
                    # Allow access to all files in the public files directory.
                    allow: true
                    expires: 5m
                    passthru: '/index.php'
                    root: 'web/sites/default/files'

                    # Do not execute PHP scripts from the writeable mount.
                    scripts: false

                    rules:
                        # Provide a longer TTL (2 weeks) for aggregated CSS and JS files.
                        '^/sites/default/files/(css|js)':
                            expires: 2w
        crons:
            drupal:
                spec: '*/19 * * * *'
                commands:
                    start: 'cd web ; drush core-cron'


# #add_service_start
# ######################################################################################################################
# # Step 3: Add a service. Uncomment this section.
# ######################################################################################################################
#         relationships:
#             redis_session: 
#                 service: "redis_service"
#                 endpoint: "redis"

services:
    redis_service:
        type: "redis:7.0"
######################################################################################################################
#add_service_end
    
# Routes configuration.
routes:
    "https://{default}/":
        id: frontend
        type: upstream
        primary: true
        upstream: "frontend:http"

    "https://www.{default}":
        id: frontend-redirect
        type: redirect
        to: "https://{default}/"

    "https://{default}/api/":
        id: backend
        type: upstream
        upstream: "backend:http"
